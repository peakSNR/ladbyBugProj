name: Build Artifacts & Release v2 (Core SDK + Wheels + CLI)

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      publish_full:
        description: "Run full release build (set false for dry-run/artifacts only)"
        required: false
        default: "true"

concurrency:
  group: shared-v2-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  packages: read

env:
  GEN: Ninja
  CIBW_BUILD: "cp312-* cp313-* cp314-*"
  CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
  CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28

jobs:
  # --------------------------------------------------------------------------
  # 1) Python sdist (source tarball) – used by all wheel jobs
  # --------------------------------------------------------------------------
  sdist-v2:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Build Python sdist
        working-directory: scripts/pip-package
        run: uv run python package_tar.py

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: python-sdist-v2
          path: scripts/pip-package/*.tar.gz

  # --------------------------------------------------------------------------
  # 2) CORE BUILD (Linux): build C++ core, tests & CLI ONCE per arch.
  #    Produce a "core SDK" that other jobs reuse.
  # --------------------------------------------------------------------------
  core-build-linux-v2:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_full == 'true')
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: blacksmith-16vcpu-ubuntu-2404
          - arch: aarch64
            runner: blacksmith-16vcpu-ubuntu-2404-arm
    runs-on: ${{ matrix.runner }}
    env:
      CCACHE_DIR: ${{ github.workspace }}/.cache/ccache
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_MAXSIZE: 10G
      EXTRA_CMAKE_FLAGS: ${{ matrix.arch == 'aarch64' && '-DSIMSIMD_TARGET_SAPPHIRE=0 -DSIMSIMD_TARGET_TURIN=0 -DBUILD_EXTENSIONS=FALSE' || '-DBUILD_EXTENSIONS=FALSE' }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Ensure build toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build build-essential cmake ccache

      - name: Set parallelism
        run: |
          echo "NUM_THREADS=$(nproc)" >> $GITHUB_ENV
          echo "TEST_JOBS=$(nproc)" >> $GITHUB_ENV
          echo "CMAKE_BUILD_PARALLEL_LEVEL=$(nproc)" >> $GITHUB_ENV

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .cache/ccache
          key: core-ccache-linux-${{ matrix.arch }}-${{ hashFiles('CMakeLists.txt','**/*.cmake') }}
          restore-keys: |
            core-ccache-linux-${{ matrix.arch }}-

      - name: Sticky disk (build directory)
        uses: useblacksmith/stickydisk@v1
        with:
          path: build
          key: core-build-linux-${{ matrix.arch }}-${{ hashFiles('CMakeLists.txt','**/*.cmake') }}

      - name: Build & install release (core + CLI)
        run: |
          make GEN=${GEN} release
          make GEN=${GEN} install PREFIX=${{ github.workspace }}/install

      - name: Collect test binaries into core SDK
        run: |
          mkdir -p core-sdk/linux-${{ matrix.arch }}/tests
          find build/src -maxdepth 1 -type f -executable -name "*test*" -print -exec cp {} core-sdk/linux-${{ matrix.arch }}/tests \; || true

      - name: Collect libraries & headers & CLI into core SDK
        run: |
          mkdir -p core-sdk/linux-${{ matrix.arch }}/cli
          mkdir -p core-sdk/linux-${{ matrix.arch }}/lib
          mkdir -p core-sdk/linux-${{ matrix.arch }}/include

          # CLI
          if [ -f "install/bin/monad" ]; then
            cp install/bin/monad core-sdk/linux-${{ matrix.arch }}/cli/
          fi

          # libs + includes
          if [ -d "install/lib" ]; then
            cp -a install/lib/. core-sdk/linux-${{ matrix.arch }}/lib/
          fi
          if [ -d "install/include" ]; then
            cp -a install/include/. core-sdk/linux-${{ matrix.arch }}/include/
          fi

      - name: Optional - collect Python bindings into core SDK (if present)
        run: |
          mkdir -p core-sdk/linux-${{ matrix.arch }}/python
          if [ -d "tools/python_api/build/monad" ]; then
            cp -a tools/python_api/build/monad/. core-sdk/linux-${{ matrix.arch }}/python/
          fi

      - name: Smoke test CLI from install
        run: |
          if [ -f "./install/bin/monad" ]; then
            ./install/bin/monad --help || (echo "CLI smoke test failed" && exit 1)
          else
            echo "monad CLI not found in install/bin, skipping smoke test"
          fi

      - name: Upload core SDK (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: monad-core-sdk-linux-${{ matrix.arch }}
          path: core-sdk/linux-${{ matrix.arch }}

  # --------------------------------------------------------------------------
  # 3) CORE BUILD (macOS): core, tests & CLI in a single universal build.
  #    Also handles signing + notarization.
  # --------------------------------------------------------------------------
  core-build-macos-v2:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_full == 'true')
    runs-on: macos-15-xlarge
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
      APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_NOTARY_KEY: ${{ secrets.APPLE_NOTARY_KEY }}
      APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
      APPLE_NOTARY_ISSUER: ${{ secrets.APPLE_NOTARY_ISSUER }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set parallelism
        run: |
          echo "NUM_THREADS=$(sysctl -n hw.logicalcpu)" >> $GITHUB_ENV
          echo "TEST_JOBS=$(sysctl -n hw.logicalcpu)" >> $GITHUB_ENV
          echo "CMAKE_BUILD_PARALLEL_LEVEL=$(sysctl -n hw.logicalcpu)" >> $GITHUB_ENV

      - name: Ensure build toolchain
        run: |
          brew update
          brew install ccache ninja cmake || true

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/ccache
          key: macos-core-ccache-universal-${{ hashFiles('CMakeLists.txt','**/*.cmake') }}
          restore-keys: macos-core-ccache-universal-

      - name: Build release (core + CLI, universal)
        run: |
          export CCACHE_CPP2=1
          cmake -S . -B build/release \
            -DCMAKE_BUILD_TYPE=Release \
            -GNinja \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DBUILD_EXTENSIONS=FALSE
          cmake --build build/release --parallel ${NUM_THREADS}
          cmake --install build/release --prefix ${GITHUB_WORKSPACE}/install

      - name: Collect test binaries into core SDK
        run: |
          mkdir -p core-sdk/macos-universal/tests
          find build/release/src -maxdepth 1 -type f -perm +111 -name "*test*" -print -exec cp {} core-sdk/macos-universal/tests \; || true

      - name: Collect libraries & headers & CLI into core SDK
        run: |
          mkdir -p core-sdk/macos-universal/cli
          mkdir -p core-sdk/macos-universal/lib
          mkdir -p core-sdk/macos-universal/include

          if [ -f "install/bin/monad" ]; then
            cp install/bin/monad core-sdk/macos-universal/cli/
          fi
          if [ -d "install/lib" ]; then
            cp -a install/lib/. core-sdk/macos-universal/lib/
          fi
          if [ -d "install/include" ]; then
            cp -a install/include/. core-sdk/macos-universal/include/
          fi

      - name: Optional: collect Python bindings into SDK (if present)
        run: |
          mkdir -p core-sdk/macos-universal/python
          if [ -d "tools/python_api/build/monad" ]; then
            cp -a tools/python_api/build/monad/. core-sdk/macos-universal/python/
          fi

      - name: Import signing certificate
        if: env.APPLE_IDENTITY != ''
        env:
          APPLE_CERT_P12_BASE64: ${{ secrets.APPLE_CERT_P12_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          echo "$APPLE_CERT_P12_BASE64" | base64 --decode > signing.p12
          security create-keychain -p "" build.keychain
          security import signing.p12 -k ~/Library/Keychains/build.keychain -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign
          security set-keychain-settings -lut 21600 build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

      - name: Sign CLI (Developer ID Application)
        if: env.APPLE_IDENTITY != ''
        run: |
          if [ -f "./install/bin/monad" ]; then
            codesign --force --options runtime --timestamp \
              --sign "$APPLE_IDENTITY" \
              ./install/bin/monad
          fi

      - name: Smoke test CLI
        run: |
          if [ -f "./install/bin/monad" ]; then
            ./install/bin/monad --help || (echo "CLI smoke test failed" && exit 1)
          else
            echo "monad CLI not found in install/bin, skipping smoke test"
          fi

      - name: Create distribution zip (for notarization)
        if: env.APPLE_IDENTITY != ''
        run: |
          if [ -f "install/bin/monad" ]; then
            cd install
            zip -j ../monad_cli-macos-universal.zip bin/monad
            cd ..
          else
            echo "monad CLI not found, skipping zip"
          fi

      - name: Write App Store Connect API key (p8)
        if: env.APPLE_IDENTITY != '' && env.APPLE_NOTARY_KEY != ''
        run: |
          echo "${APPLE_NOTARY_KEY}" > notarykey.p8

      - name: Notarize (zip)
        if: env.APPLE_IDENTITY != '' && env.APPLE_NOTARY_KEY != ''
        run: |
          if [ -f "monad_cli-macos-universal.zip" ]; then
            xcrun notarytool submit monad_cli-macos-universal.zip \
              --key notarykey.p8 \
              --key-id "$APPLE_NOTARY_KEY_ID" \
              --issuer "$APPLE_NOTARY_ISSUER" \
              --wait
          else
            echo "monad_cli-macos-universal.zip not found, skipping notarization"
          fi

      - name: Upload core SDK (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: monad-core-sdk-macos-universal
          path: core-sdk/macos-universal

      - name: Clean up signing keychain & notary key
        if: always()
        run: |
          security delete-keychain build.keychain || true
          rm -f signing.p12 notarykey.p8 || true

  # --------------------------------------------------------------------------
  # 4) CLI PACKAGING (NO BUILD) – re-use core SDK artifacts only
  # --------------------------------------------------------------------------
  linux-cli-v2:
    needs: core-build-linux-v2
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_full == 'true')
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
          - arch: aarch64
    runs-on: ubuntu-latest

    steps:
      - name: Download core SDK
        uses: actions/download-artifact@v4
        with:
          name: monad-core-sdk-linux-${{ matrix.arch }}
          path: core-sdk/linux-${{ matrix.arch }}

      - name: Verify CLI works from SDK
        run: |
          CLI_PATH="core-sdk/linux-${{ matrix.arch }}/cli/monad"
          if [ -f "${CLI_PATH}" ]; then
            chmod +x "${CLI_PATH}" || true
            "${CLI_PATH}" --help || (echo "CLI smoke test failed after download" && exit 1)
          else
            echo "CLI monad not found in SDK, skipping smoke test"
          fi

      - name: Package CLI (Linux)
        run: |
          arch="${{ matrix.arch }}"
          if [ -d "core-sdk/linux-${arch}/cli" ]; then
            tar -czvf monad_cli-linux-${arch}.tar.gz \
              -C core-sdk/linux-${arch}/cli . \
              -C $GITHUB_WORKSPACE LICENSE
          else
            echo "core-sdk/linux-${arch}/cli not found, failing"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: monad_cli-linux-${{ matrix.arch }}
          path: monad_cli-linux-${{ matrix.arch }}.tar.gz

      - name: Package lib (Linux)
        run: |
          arch="${{ matrix.arch }}"
          if [ -d "core-sdk/linux-${arch}/lib" ] && [ -d "core-sdk/linux-${arch}/include" ]; then
            tar -czvf libmonad-linux-${arch}.tar.gz \
              -C core-sdk/linux-${arch}/include . \
              -C core-sdk/linux-${arch}/lib . \
              -C $GITHUB_WORKSPACE LICENSE
          else
            echo "core-sdk/linux-${arch}/lib or include not found, failing"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: libmonad-linux-${{ matrix.arch }}
          path: libmonad-linux-${{ matrix.arch }}.tar.gz

  macos-cli-v2:
    needs: core-build-macos-v2
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_full == 'true')
    runs-on: macos-15-xlarge
    steps:
      - name: Download core SDK
        uses: actions/download-artifact@v4
        with:
          name: monad-core-sdk-macos-universal
          path: core-sdk/macos-universal

      - name: Prepare CLI binary (macOS universal)
        run: |
          if [ -f "core-sdk/macos-universal/cli/monad" ]; then
            cp core-sdk/macos-universal/cli/monad monad_cli-macos-universal
            chmod +x monad_cli-macos-universal
          else
            echo "CLI monad not found in macOS SDK"
            exit 1
          fi

      - name: Smoke test CLI from SDK
        run: |
          ./monad_cli-macos-universal --help || (echo "CLI smoke test failed after download" && exit 1)

      - uses: actions/upload-artifact@v4
        with:
          name: monad_cli-macos-universal
          path: monad_cli-macos-universal

      - name: Package lib (macOS universal)
        run: |
          if [ -d "core-sdk/macos-universal/include" ] && [ -d "core-sdk/macos-universal/lib" ]; then
            tar -czvf libmonad-macos-universal.tar.gz \
              -C core-sdk/macos-universal/include . \
              -C core-sdk/macos-universal/lib . \
              -C $GITHUB_WORKSPACE LICENSE
          else
            echo "macOS SDK include/lib not found, failing"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: libmonad-macos-universal
          path: libmonad-macos-universal.tar.gz

  # --------------------------------------------------------------------------
  # 5) WHEELS v2 – CPython 3.12, 3.13, 3.14 for Linux & macOS
  #    (cibuildwheel + ccache)
  # --------------------------------------------------------------------------
  linux-wheels-v2:
    needs: sdist-v2
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: blacksmith-16vcpu-ubuntu-2404
          - arch: aarch64
            runner: blacksmith-16vcpu-ubuntu-2404-arm
    runs-on: ${{ matrix.runner }}
    env:
      CCACHE_DIR: ${{ github.workspace }}/.cache/ccache
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_MAXSIZE: 10G
      CIBW_PLATFORM: linux
      CIBW_ARCHS: ${{ matrix.arch }}
      EXTRA_CMAKE_FLAGS: ${{ matrix.arch == 'aarch64' && '-DSIMSIMD_TARGET_SAPPHIRE=0 -DSIMSIMD_TARGET_TURIN=0 -DBUILD_EXTENSIONS=FALSE' || '-DBUILD_EXTENSIONS=FALSE' }}
      CIBW_ENVIRONMENT: >
        CCACHE_DIR=${{ github.workspace }}/.cache/ccache
        CCACHE_BASEDIR=${{ github.workspace }}
        CCACHE_MAXSIZE=10G
        CMAKE_ARGS="-DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -GNinja -DBUILD_EXTENSIONS=FALSE"
      CIBW_TEST_REQUIRES: pytest
      CIBW_TEST_COMMAND: |
        python - <<'PY'
        from monad import Database, Connection
        db = Database(":memory:")
        conn = Connection(db)
        res = conn.execute("RETURN 1")
        print(res.get_all())
        PY
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set parallelism
        run: |
          echo "NUM_THREADS=$(nproc)" >> $GITHUB_ENV
          echo "TEST_JOBS=$(nproc)" >> $GITHUB_ENV

      - name: Sticky disk (ccache)
        uses: actions/cache@v4
        with:
          path: .cache/ccache
          key: wheels-ccache-v2-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('CMakeLists.txt','**/*.cmake','tools/python_api/**','scripts/pip-package/**') }}
          restore-keys: |
            wheels-ccache-v2-${{ runner.os }}-${{ matrix.arch }}-

      - name: Sticky disk (build dir)
        uses: useblacksmith/stickydisk@v1
        with:
          path: build
          key: wheels-build-v2-${{ matrix.arch }}-${{ hashFiles('CMakeLists.txt','**/*.cmake','tools/python_api/**','scripts/pip-package/**') }}

      - name: Ensure build toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build build-essential cmake ccache

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: python-sdist-v2
          path: scripts/pip-package

      - name: Build wheels (Linux, v2)
        run: |
          sdist=$(ls scripts/pip-package/*.tar.gz)
          uv run python -m pip install cibuildwheel
          uv run python -m cibuildwheel --output-dir scripts/pip-package/wheelhouse "$sdist"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-v2-${{ matrix.arch }}
          path: scripts/pip-package/wheelhouse/*.whl

  macos-wheels-v2:
    needs: sdist-v2
    runs-on: macos-15-xlarge
    env:
      CIBW_PLATFORM: macos
      CIBW_ARCHS: "arm64 x86_64"
      MACOSX_DEPLOYMENT_TARGET: "11.0"
      CIBW_ENVIRONMENT: >
        CMAKE_ARGS="-GNinja -DBUILD_EXTENSIONS=FALSE"
      CIBW_TEST_REQUIRES: pytest
      CIBW_TEST_COMMAND: |
        python - <<'PY'
        from monad import Database, Connection
        db = Database(":memory:")
        conn = Connection(db)
        res = conn.execute("RETURN 1")
        print(res.get_all())
        PY
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: python-sdist-v2
          path: scripts/pip-package

      - name: Build wheels (macOS, v2)
        run: |
          sdist=$(ls scripts/pip-package/*.tar.gz)
          uv run python -m pip install cibuildwheel
          uv run python -m cibuildwheel --output-dir scripts/pip-package/wheelhouse "$sdist"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-v2-universal
          path: scripts/pip-package/wheelhouse/*.whl

  # --------------------------------------------------------------------------
  # 6) PUBLISH v2 – Upload wheels + CLI + libs for tagged releases
  # --------------------------------------------------------------------------
  publish-v2:
    if: startsWith(github.ref, 'refs/tags/') && (github.event_name == 'push' || inputs.publish_full == 'true')
    needs:
      - sdist-v2
      - linux-wheels-v2
      - macos-wheels-v2
      - linux-cli-v2
      - macos-cli-v2
    runs-on: ubuntu-latest
    env:
      GAR_PROJECT: ${{ secrets.GAR_PROJECT_ID }}
      GAR_LOCATION: "us"
      GAR_REPOSITORY: "monad-python"
    steps:
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "wheels-*-v2*"
          path: dist/python
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          name: python-sdist-v2
          path: dist/python

      - name: Download binary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "monad_cli-*"
          path: dist/binaries
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: "libmonad-*"
          path: dist/binaries
          merge-multiple: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_ARTIFACT_REGISTRY_CREDENTIAL }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GAR_PROJECT_ID }}

      - name: Get access token
        id: token
        run: echo "access_token=$(gcloud auth print-access-token)" >> "$GITHUB_OUTPUT"

      - name: Upload wheels to Artifact Registry
        env:
          TWINE_USERNAME: oauth2accesstoken
          TWINE_PASSWORD: ${{ steps.token.outputs.access_token }}
        run: |
          python -m pip install --upgrade pip twine
          repo_url="https://${GAR_LOCATION}-python.pkg.dev/${GAR_PROJECT}/${GAR_REPOSITORY}/"
          twine upload --repository-url "$repo_url" dist/python/*.whl dist/python/*.tar.gz

      - name: Publish GitHub Release (v2 artifacts)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**
          generate_release_notes: true
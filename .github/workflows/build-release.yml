name: Build Artifacts & Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      publish_full:
        description: "Run full release build (set false for dry-run/artifacts only)"
        required: false
        default: "true"

concurrency:
  # Share group with CI on same ref so starting a release cancels any in-flight CI.
  group: shared-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  packages: read

env:
  GEN: Ninja
  CIBW_BUILD: "cp312-* cp313-* cp314-*"
  CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
  CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28

jobs:
  sdist:
    # Version check temporarily disabled
    runs-on: self-hosted  #blacksmith-8vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Build Python sdist
        working-directory: scripts/pip-package
        run: uv run python package_tar.py

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: python-sdist
          path: scripts/pip-package/*.tar.gz

  linux-wheels:
    needs: sdist
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: blacksmith-16vcpu-ubuntu-2404
          - arch: aarch64
            runner: blacksmith-16vcpu-ubuntu-2404-arm
    runs-on: ${{ matrix.runner }}
    env:
      CCACHE_DIR: ${{ github.workspace }}/.cache/ccache
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_MAXSIZE: 10G
      CIBW_PLATFORM: linux
      CIBW_ARCHS: ${{ matrix.arch }}
      EXTRA_CMAKE_FLAGS: ${{ matrix.arch == 'aarch64' && '-DSIMSIMD_TARGET_SAPPHIRE=0 -DSIMSIMD_TARGET_TURIN=0 -DBUILD_EXTENSIONS=FALSE' || '-DBUILD_EXTENSIONS=FALSE' }}
      CIBW_ENVIRONMENT: >
        CCACHE_DIR=${{ github.workspace }}/.cache/ccache
        CCACHE_BASEDIR=${{ github.workspace }}
        CCACHE_MAXSIZE=10G
        CMAKE_ARGS="-DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -GNinja -DBUILD_EXTENSIONS=FALSE"
      CIBW_TEST_REQUIRES: pytest
      CIBW_TEST_COMMAND: |
        python - <<'PY'
        from monad import Database, Connection
        db = Database(":memory:")
        conn = Connection(db)
        res = conn.execute("RETURN 1")
        print(res.get_all())
        PY
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set parallelism
        run: |
          echo "NUM_THREADS=$(nproc)" >> $GITHUB_ENV
          echo "TEST_JOBS=$(nproc)" >> $GITHUB_ENV

      - name: Sticky disk (ccache)
        uses: actions/cache@v4
        with:
          path: .cache/ccache
          key: wheels-ccache-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('CMakeLists.txt','**/*.cmake','tools/python_api/**','scripts/pip-package/**') }}
          restore-keys: |
            wheels-ccache-${{ runner.os }}-${{ matrix.arch }}-

      - name: Sticky disk (build)
        uses: useblacksmith/stickydisk@v1
        with:
          path: build
          key: wheels-build-${{ matrix.arch }}-${{ hashFiles('CMakeLists.txt','**/*.cmake','tools/python_api/**','scripts/pip-package/**') }}

      - name: Ensure build toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build build-essential cmake ccache

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: python-sdist
          path: scripts/pip-package

      - name: Build wheels (Linux)
        run: |
          sdist=$(ls scripts/pip-package/*.tar.gz)
          uv run python -m pip install cibuildwheel
          uv run python -m cibuildwheel --output-dir scripts/pip-package/wheelhouse "$sdist"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.arch }}
          path: scripts/pip-package/wheelhouse/*.whl

  macos-wheels:
    needs: sdist
    runs-on: macos-15-xlarge
    env:
      CIBW_PLATFORM: macos
      CIBW_ARCHS: "arm64 x86_64"
      MACOSX_DEPLOYMENT_TARGET: "11.0"
      CIBW_ENVIRONMENT: >
        CMAKE_ARGS="-GNinja -DBUILD_EXTENSIONS=FALSE"
      CIBW_TEST_REQUIRES: pytest
      CIBW_TEST_COMMAND: |
        python - <<'PY'
        from monad import Database, Connection
        db = Database(":memory:")
        conn = Connection(db)
        res = conn.execute("RETURN 1")
        print(res.get_all())
        PY
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: python-sdist
          path: scripts/pip-package

      - name: Build wheels (macOS)
        run: |
          sdist=$(ls scripts/pip-package/*.tar.gz)
          uv run python -m pip install cibuildwheel
          uv run python -m cibuildwheel --output-dir scripts/pip-package/wheelhouse "$sdist"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-universal
          path: scripts/pip-package/wheelhouse/*.whl

  windows-wheels:
    if: false
    needs: sdist
    runs-on: blacksmith-16vcpu-windows-2025
    env:
      CIBW_PLATFORM: windows
      CIBW_ARCHS: "AMD64"
      CIBW_ENVIRONMENT: >
        CMAKE_ARGS="-GNinja -DBUILD_EXTENSIONS=FALSE"
      CIBW_TEST_REQUIRES: pytest
      CIBW_TEST_COMMAND: |
        python - <<'PY'
        from monad import Database, Connection
        db = Database(":memory:")
        conn = Connection(db)
        res = conn.execute("RETURN 1")
        print(res.get_all())
        PY
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Install build tools
        run: |
          choco install -y ninja cmake

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: python-sdist
          path: scripts/pip-package

      - name: Build wheels (Windows)
        run: |
          $sdist = Get-ChildItem scripts/pip-package/*.tar.gz | Select-Object -First 1
          uv run python -m pip install cibuildwheel
          uv run python -m cibuildwheel --output-dir scripts/pip-package/wheelhouse $sdist

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-amd64
          path: scripts/pip-package/wheelhouse/*.whl

  linux-binaries:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_full == 'true')
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: blacksmith-16vcpu-ubuntu-2404
          - arch: aarch64
            runner: blacksmith-16vcpu-ubuntu-2404-arm
    runs-on: ${{ matrix.runner }}
    env:
      CCACHE_DIR: ${{ github.workspace }}/.cache/ccache
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_MAXSIZE: 10G
      EXTRA_CMAKE_FLAGS: ${{ matrix.arch == 'aarch64' && '-DSIMSIMD_TARGET_SAPPHIRE=0 -DSIMSIMD_TARGET_TURIN=0 -DBUILD_EXTENSIONS=FALSE' || '-DBUILD_EXTENSIONS=FALSE' }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Ensure build toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build build-essential cmake ccache

      - name: Set parallelism
        run: |
          echo "NUM_THREADS=$(nproc)" >> $GITHUB_ENV
          echo "TEST_JOBS=$(nproc)" >> $GITHUB_ENV

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .cache/ccache
          key: bin-ccache-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('CMakeLists.txt','**/*.cmake') }}
          restore-keys: |
            bin-ccache-${{ runner.os }}-${{ matrix.arch }}-

      - name: Sticky disk (build)
        uses: useblacksmith/stickydisk@v1
        with:
          path: build
          key: bin-build-${{ matrix.arch }}-${{ hashFiles('CMakeLists.txt','**/*.cmake') }}

      - name: Build release binaries
        run: |
          make GEN=${GEN} release
          make GEN=${GEN} install PREFIX=${{ github.workspace }}/install

      - name: Smoke test CLI
        run: |
          ./install/bin/monad --help || (echo "CLI smoke test failed" && exit 1)

      - name: Package CLI
        run: |
          arch="${{ matrix.arch }}"
          tar -czvf monad_cli-linux-${arch}.tar.gz \
            -C install bin \
            -C $GITHUB_WORKSPACE LICENSE

      - uses: actions/upload-artifact@v4
        with:
          name: monad_cli-linux-${{ matrix.arch }}
          path: monad_cli-linux-${{ matrix.arch }}.tar.gz

      - name: Package lib
        run: |
          arch="${{ matrix.arch }}"
          tar -czvf libmonad-linux-${arch}.tar.gz \
            -C install include lib \
            -C $GITHUB_WORKSPACE LICENSE

      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          path: install
          output-file: sbom-linux-${{ matrix.arch }}.spdx.json
          upload-artifact: false

      - uses: actions/upload-artifact@v4
        with:
          name: sbom-linux-${{ matrix.arch }}
          path: sbom-linux-${{ matrix.arch }}.spdx.json

      - uses: actions/upload-artifact@v4
        with:
          name: libmonad-linux-${{ matrix.arch }}
          path: libmonad-linux-${{ matrix.arch }}.tar.gz

  macos-binaries:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish_full == 'true')
    runs-on: macos-15-xlarge
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
      APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_NOTARY_KEY: ${{ secrets.APPLE_NOTARY_KEY }}
      APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
      APPLE_NOTARY_ISSUER: ${{ secrets.APPLE_NOTARY_ISSUER }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set parallelism
        run: |
          echo "NUM_THREADS=$(sysctl -n hw.logicalcpu)" >> $GITHUB_ENV
          echo "TEST_JOBS=$(sysctl -n hw.logicalcpu)" >> $GITHUB_ENV
          echo "CMAKE_BUILD_PARALLEL_LEVEL=$(sysctl -n hw.logicalcpu)" >> $GITHUB_ENV

      - name: Ensure build toolchain
        run: |
          brew update
          brew install ccache ninja cmake || true

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/ccache
          key: macos-ccache-universal-${{ hashFiles('CMakeLists.txt','**/*.cmake') }}
          restore-keys: macos-ccache-universal-

      - name: Build release (native arch)
        run: |
          export CCACHE_CPP2=1
          cmake -S . -B build/release \
            -DCMAKE_BUILD_TYPE=Release \
            -GNinja \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DBUILD_EXTENSIONS=FALSE
          cmake --build build/release --parallel ${NUM_THREADS}

      - name: Install artifacts
        run: |
          cmake --install build/release --prefix ${GITHUB_WORKSPACE}/install

      - name: Import signing certificate
        if: env.APPLE_IDENTITY != ''
        env:
          APPLE_CERT_P12_BASE64: ${{ secrets.APPLE_CERT_P12_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          echo "$APPLE_CERT_P12_BASE64" | base64 --decode > signing.p12
          security create-keychain -p "" build.keychain
          security import signing.p12 -k ~/Library/Keychains/build.keychain -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign
          security set-keychain-settings -lut 21600 build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

      - name: Sign CLI (Developer ID Application)
        if: env.APPLE_IDENTITY != ''
        run: |
          codesign --force --options runtime --timestamp \
            --sign "$APPLE_IDENTITY" \
            ./install/bin/monad

      - name: Create distribution zip (for notarization)
        run: |
          cd install
          zip -j ../monad_cli-macos-universal.zip bin/monad
          cd ..

      - name: Write App Store Connect API key (p8)
        if: env.APPLE_IDENTITY != '' && env.APPLE_NOTARY_KEY != ''
        run: |
          echo "${APPLE_NOTARY_KEY}" > notarykey.p8

      - name: Notarize (zip)
        if: env.APPLE_IDENTITY != ''
        run: |
          xcrun notarytool submit monad_cli-macos-universal.zip \
            --key notarykey.p8 \
            --key-id "$APPLE_NOTARY_KEY_ID" \
            --issuer "$APPLE_NOTARY_ISSUER" \
            --wait

      - name: Prepare binary artifact (signed)
        run: |
          cp install/bin/monad monad_cli-macos-universal

      - name: Smoke test CLI
        run: |
          ./install/bin/monad --help || (echo "CLI smoke test failed" && exit 1)

      - uses: actions/upload-artifact@v4
        with:
          name: monad_cli-macos-universal
          path: monad_cli-macos-universal

      - name: Package lib
        run: |
          tar -czvf libmonad-macos-universal.tar.gz \
            -C install include lib \
            -C $GITHUB_WORKSPACE LICENSE

      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          path: install
          output-file: sbom-macos-universal.spdx.json
          upload-artifact: false

      - uses: actions/upload-artifact@v4
        with:
          name: sbom-macos-universal
          path: sbom-macos-universal.spdx.json

      - uses: actions/upload-artifact@v4
        with:
          name: libmonad-macos-universal
          path: libmonad-macos-universal.tar.gz

      - name: Clean up signing keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true
          rm -f signing.p12 notarykey.p8

  windows-binaries:
    if: false
    runs-on: blacksmith-16vcpu-windows-2025
    env:
      EXTRA_CMAKE_FLAGS: -DBUILD_EXTENSIONS=FALSE
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build tools
        run: |
          choco install -y ninja cmake

      - name: Set parallelism
        run: |
          echo "NUM_THREADS=$Env:NUMBER_OF_PROCESSORS" >> $Env:GITHUB_ENV
          echo "TEST_JOBS=$Env:NUMBER_OF_PROCESSORS" >> $Env:GITHUB_ENV

      - name: Configure
        run: |
          cmake -S . -B build\release `
            -DCMAKE_BUILD_TYPE=Release `
            -GNinja `
            -DBUILD_EXTENSIONS=FALSE

      - name: Build release binaries
        run: cmake --build build\release --config Release --parallel $Env:NUM_THREADS

      - name: Install artifacts
        run: cmake --install build\release --prefix $Env:GITHUB_WORKSPACE\install

      - name: Smoke test CLI
        run: |
          ./install/bin/monad.exe --help

      - name: Package CLI
        run: |
          7z a monad_cli-windows-amd64.zip install\bin\monad.exe LICENSE

      - uses: actions/upload-artifact@v4
        with:
          name: monad_cli-windows-amd64
          path: monad_cli-windows-amd64.zip

      - name: Package lib
        run: |
          7z a libmonad-windows-amd64.zip install\include\* install\lib\* install\bin\*.dll LICENSE

      - uses: actions/upload-artifact@v4
        with:
          name: libmonad-windows-amd64
          path: libmonad-windows-amd64.zip

  publish:
    if: startsWith(github.ref, 'refs/tags/') && (github.event_name == 'push' || inputs.publish_full == 'true')
    needs:
      - sdist
      - linux-wheels
      - macos-wheels
      - linux-binaries
      - macos-binaries
    runs-on: ubuntu-latest
    env:
      GAR_PROJECT: ${{ secrets.GAR_PROJECT_ID }}
      GAR_LOCATION: "us"
      GAR_REPOSITORY: "monad-python"
    steps:
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "wheels-*"
          path: dist/python
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          name: python-sdist
          path: dist/python

      - name: Download binary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "monad-*"
          path: dist/binaries
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: "monad_cli-*"
          path: dist/binaries
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: "libmonad-*"
          path: dist/binaries
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: "sbom-*"
          path: dist/sbom
          merge-multiple: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_ARTIFACT_REGISTRY_CREDENTIAL }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GAR_PROJECT_ID }}

      - name: Get access token
        id: token
        run: echo "access_token=$(gcloud auth print-access-token)" >> "$GITHUB_OUTPUT"

      - name: Upload wheels to Artifact Registry
        env:
          TWINE_USERNAME: oauth2accesstoken
          TWINE_PASSWORD: ${{ steps.token.outputs.access_token }}
        run: |
          python -m pip install --upgrade pip twine
          repo_url="https://${GAR_LOCATION}-python.pkg.dev/${GAR_PROJECT}/${GAR_REPOSITORY}/"
          twine upload --repository-url "$repo_url" dist/python/*.whl dist/python/*.tar.gz

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**
          generate_release_notes: true
